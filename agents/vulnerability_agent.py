from core import mcp, datastore
import uuid, time

def run():
    try:
        vulns = mcp.query("vulnerability_report", source="vulnerability_agent")["payload"]
        critical_unpatched = [v for v in vulns if str(v.get("severity", "")).lower() == "critical" and str(v.get("patched", "")).lower() == "no"]

        datastore.insert_finding(
            str(uuid.uuid4()),
            "vulnerability_agent",
            {"critical_unpatched_count": len(critical_unpatched), "details": critical_unpatched},
            int(time.time())
        )
        return critical_unpatched
    except Exception as e:
        print(f"Error in vulnerability_agent: {e}")
        return []

if __name__ == "__main__":
    print(run())
